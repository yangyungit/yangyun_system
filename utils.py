import json
import os
import streamlit as st
from datetime import datetime

# --- é…ç½®åŒº ---
# 1. æ•°æ®å­˜å‚¨æ–‡ä»¶
DB_FILE = "news_database.json"

# 2. Obsidian ä»“åº“è·¯å¾„ (éœ€è¦ä¿®æ”¹ä¸ºä½ ç”µè„‘ä¸Šçš„çœŸå®è·¯å¾„!)
# ä¾‹å¦‚: "/Users/zhanghao/yangyun/Code_projects/obsidian_notes/å…»äº‘åä½œ/å†³ç­–å½’æ¡£"
OBSIDIAN_PATH = "/Users/zhanghao/yangyun/Code_projects/obsidian_notes" 

# --- åŠŸèƒ½ 1: åŠ è½½/ä¿å­˜é›·è¾¾æ•°æ® ---
def load_data():
    """ä»æœ¬åœ° JSON æ–‡ä»¶åŠ è½½æ•°æ®ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è¿”å›é»˜è®¤ç©ºåˆ—è¡¨"""
    if os.path.exists(DB_FILE):
        with open(DB_FILE, "r", encoding="utf-8") as f:
            return json.load(f)
    return [] # è¿”å›ç©ºåˆ—è¡¨ï¼Œç­‰å¾…åˆå§‹åŒ–

def save_data(news_list):
    """æŠŠé›·è¾¾æ•°æ®ä¿å­˜åˆ°æœ¬åœ° JSON"""
    with open(DB_FILE, "w", encoding="utf-8") as f:
        json.dump(news_list, f, ensure_ascii=False, indent=4)

# --- åŠŸèƒ½ 2: å¯¼å‡ºå†³ç­–åˆ° Obsidian ---
def save_to_obsidian(case_data, decision_note):
    """
    ç”Ÿæˆ Markdown æ–‡ä»¶å¹¶å†™å…¥ Obsidian æ–‡ä»¶å¤¹
    """
    # 1. ç”Ÿæˆæ–‡ä»¶å (ä¾‹å¦‚: 2026-02-06_NVDA_å†³ç­–å¤‡å¿˜.md)
    date_str = datetime.now().strftime("%Y-%m-%d")
    clean_title = case_data['title'].replace("/", "_").replace(" ", "_")
    filename = f"{date_str}_{clean_title}.md"
    full_path = os.path.join(OBSIDIAN_PATH, filename)
    
    # 2. ç”Ÿæˆ Markdown å†…å®¹ (Beancount é£æ ¼æ ‡ç­¾)
    content = f"""---
id: {case_data['id']}
date: {date_str}
tags: {case_data['tags']}
surprise: {case_data['surprise']}
status: Closed
---

# âš–ï¸ å†³ç­–å¤‡å¿˜å½•: {case_data['title']}

## 1. æ ¸å¿ƒæƒ…æŠ¥
> {case_data['summary']}

## 2. ä¾¦æ¢æŠ¥å‘Š (Evidence)
{case_data.get('investigation', 'æ— è¯¦ç»†æŠ¥å‘Š')}

## 3. æœ€ç»ˆè£å†³ (Verdict)
**ğŸ‘¨â€âš–ï¸ æ³•å®˜ç¬”è®°:**
{decision_note}

---
*Generated by YangYun AI System*
"""

    # 3. å†™å…¥æ–‡ä»¶
    try:
        # ç¡®ä¿ç›®å½•å­˜åœ¨
        os.makedirs(os.path.dirname(full_path), exist_ok=True)
        with open(full_path, "w", encoding="utf-8") as f:
            f.write(content)
        return True, full_path
    except Exception as e:
        return False, str(e)
    
# ... (ä¸Šé¢çš„ä»£ç ä¿æŒä¸å˜) ...

# --- åŠŸèƒ½ 3: äº’è”ç½‘æœç´¢ (V0.6 æ–°å¢) ---
from duckduckgo_search import DDGS

def search_web(query, max_results=5):
    """
    ä½¿ç”¨ DuckDuckGo æœç´¢å®æ—¶ä¿¡æ¯
    """
    try:
        results = DDGS().text(query, max_results=max_results)
        if not results:
            return "æœªæ‰¾åˆ°ç›¸å…³ç½‘ç»œç»“æœã€‚"
        
        # æŠŠç»“æœæ•´ç†æˆå¹²å‡€çš„æ–‡æœ¬
        formatted_results = ""
        for i, res in enumerate(results):
            formatted_results += f"Source {i+1}: {res['title']}\nURL: {res['href']}\nContent: {res['body']}\n\n"
            
        return formatted_results
    except Exception as e:
        return f"æœç´¢å¤±è´¥: {str(e)}"
    
    # ... (ä¸Šé¢çš„ä»£ç ä¿æŒä¸å˜) ...

# ... (ä¿ç•™ä¸Šé¢çš„ imports å’Œ search_web) ...
import pandas as pd
import yfinance as yf

# --- åŠŸèƒ½ 4 (å‡çº§): å¢å¼ºç‰ˆé‡‘èæ•°æ® (å«æŠ€æœ¯é¢) ---
def get_stock_analysis(symbol):
    """
    è·å–åŸºæœ¬é¢ + æŠ€æœ¯é¢ (MA, è¶‹åŠ¿) æ•°æ®
    """
    try:
        # 1. è·å–åŸºç¡€ä¿¡æ¯
        ticker = yf.Ticker(symbol)
        info = ticker.info
        
        # 2. è·å–å†å²Kçº¿ (ç”¨äºç®—å‡çº¿) - å–è¿‡å»6ä¸ªæœˆ
        hist = ticker.history(period="6mo") 
        if hist.empty:
            return f"æ— æ³•è·å– {symbol} çš„Kçº¿æ•°æ®"
            
        current_price = info.get('currentPrice', hist['Close'].iloc[-1])
        
        # 3. è®¡ç®—ç®€å•æŠ€æœ¯æŒ‡æ ‡ (Python è‡ªå·±ç®—ï¼Œä¸æ±‚äºº)
        hist['MA20'] = hist['Close'].rolling(window=20).mean()
        hist['MA50'] = hist['Close'].rolling(window=50).mean()
        hist['Vol_MA'] = hist['Volume'].rolling(window=20).mean()
        
        last_close = hist['Close'].iloc[-1]
        ma20 = hist['MA20'].iloc[-1]
        ma50 = hist['MA50'].iloc[-1]
        last_vol = hist['Volume'].iloc[-1]
        avg_vol = hist['Vol_MA'].iloc[-1]
        
        # 4. ç®€å•è¶‹åŠ¿åˆ¤æ–­é€»è¾‘
        trend = "éœ‡è¡/ä¸æ˜"
        if last_close > ma20 > ma50:
            trend = "ğŸ”¥ å¤šå¤´æ’åˆ— (å¼ºåŠ¿)"
        elif last_close < ma20 < ma50:
            trend = "â„ï¸ ç©ºå¤´æ’åˆ— (å¼±åŠ¿)"
            
        vol_status = "ç¼©é‡"
        if last_vol > avg_vol * 1.5:
            vol_status = "ğŸš¨ æ”¾é‡ (æ³¨æ„å˜ç›˜)"
        
        # 5. ç»„è£…ç»™ AI çœ‹çš„æŠ¥å‘Š
        report = f"""
ã€ğŸ“ˆ æ ‡çš„æ·±åº¦æ‰«æ: {symbol.upper()}ã€‘
---------------------------
ğŸ’° **ä»·æ ¼:** {current_price}
ğŸ“Š **è¶‹åŠ¿çŠ¶æ€:** {trend}
ğŸŒŠ **é‡èƒ½çŠ¶æ€:** {vol_status}
---------------------------
ğŸ›  **æŠ€æœ¯é¢ä¿¡å·:**
- MA20 (æœˆçº¿): {ma20:.2f}
- MA50 (å­£çº¿): {ma50:.2f}
- ç°ä»·/MA20ä¹–ç¦»: {((last_close/ma20)-1)*100:.1f}% (æ­£å€¼è¿‡å¤§éœ€è­¦æƒ•å›è°ƒ)
- 52å‘¨èŒƒå›´: {info.get('fiftyTwoWeekLow')} - {info.get('fiftyTwoWeekHigh')}
---------------------------
P **åŸºæœ¬é¢ä¼°å€¼:**
- å¸‚å€¼: {info.get('marketCap', 'N/A')}
- PE (TTM): {info.get('trailingPE', 'N/A')}
- Forward PE: {info.get('forwardPE', 'N/A')}
- PEG Ratio: {info.get('pegRatio', 'N/A')}
"""
        return report
    except Exception as e:
        return f"è·å– {symbol} æ•°æ®å¤±è´¥: {str(e)}"

# --- åŠŸèƒ½ 5 (æ–°å¢): å®è§‚å¤©æ°”é¢„æŠ¥ ---
def get_macro_context():
    """
    è·å–å…³é”®å®è§‚æŒ‡æ ‡ï¼šç¾å€ºã€ææ…ŒæŒ‡æ•°ã€ç¾å…ƒã€é»„é‡‘
    """
    try:
        # 10å¹´ç¾å€º(^TNX), VIX(^VIX), ç¾å…ƒæŒ‡æ•°(DX-Y.NYB), é»„é‡‘(GC=F)
        tickers = ["^TNX", "^VIX", "DX-Y.NYB", "GC=F"] 
        data = yf.download(tickers, period="5d", progress=False)['Close']
        
        # å–æœ€æ–°å€¼ (å¤„ç†æ•°æ®æ ¼å¼å¯èƒ½å¸¦æ¥çš„å¤šå±‚ç´¢å¼•é—®é¢˜)
        latest = data.iloc[-1]
        
        # ç®€å•è§£è¯»é€»è¾‘
        tnx = latest['^TNX']
        vix = latest['^VIX']
        dxy = latest['DX-Y.NYB']
        
        macro_status = "ğŸŒªï¸ æ··æ²Œ"
        if vix > 25: macro_status = "â›ˆï¸ æåº¦ææ…Œ (Risk-Off)"
        elif tnx > 4.5 and dxy > 105: macro_status = "ğŸ§Š ç´§ç¼©å‹åˆ¶ (æµåŠ¨æ€§æ”¶ç´§)"
        elif tnx < 4.0 and vix < 15: macro_status = "â˜€ï¸ æ¸©å’Œé¡ºé£ (Risk-On)"
        
        report = f"""
ğŸŒ **å®è§‚å¤©æ°”é¢„æŠ¥ (Macro Context)**
çŠ¶æ€åˆ¤å®š: ã€{macro_status}ã€‘
---------------------------
Yield (10Yç¾å€º): {tnx:.2f}% (æ— é£é™©åˆ©ç‡é”š)
VIX (ææ…ŒæŒ‡æ•°): {vix:.2f} (å¸‚åœºæƒ…ç»ªæ¸©åº¦è®¡)
DXY (ç¾å…ƒæŒ‡æ•°): {dxy:.2f} (å…¨çƒèµ„é‡‘æµå‘)
Gold (é»„é‡‘): ${latest['GC=F']:.0f}
"""
        return report
    except Exception as e:
        return f"å®è§‚æ•°æ®æš‚æ—¶ç¦»çº¿: {e}"
    
# ... (ä¿ç•™ä¸Šé¢çš„ä»£ç ) ...
import plotly.graph_objects as go

# --- åŠŸèƒ½ 6 (V3.0): å®è§‚æ•°æ®çŸ©é˜µ ---
def get_macro_matrix():
    """
    è·å–å¤šç»´åº¦çš„å®è§‚èµ„äº§æ•°æ®ï¼Œç”¨äºè¾…åŠ©åˆ¤æ–­å‘¨æœŸ
    """
    tickers = {
        "10Y ç¾å€º (æ— é£é™©åˆ©ç‡)": "^TNX",
        "2Y ç¾å€º (æ”¿ç­–åˆ©ç‡é¢„æœŸ)": "^IRX",
        "ç¾å…ƒæŒ‡æ•° (æµåŠ¨æ€§é˜€é—¨)": "DX-Y.NYB",
        "VIX (ææ…ŒæŒ‡æ•°)": "^VIX",
        "é»„é‡‘ (é¿é™©/é€šèƒ€)": "GC=F",
        "åŸæ²¹ (é€šèƒ€é¢„æœŸ)": "CL=F",
        "æ¯”ç‰¹å¸ (é£é™©åå¥½)": "BTC-USD",
        "æ ‡æ™®500 (è‚¡å¸‚æ™´é›¨è¡¨)": "^GSPC"
    }
    
    data_snapshot = {}
    try:
        # ä¸€æ¬¡æ€§ä¸‹è½½æ‰€æœ‰æ•°æ®ï¼Œå–è¿‡å» 1 å¹´ï¼Œæ–¹ä¾¿ç®—å˜åŒ–ç‡
        df = yf.download(list(tickers.values()), period="1y", progress=False)['Close']
        
        for name, symbol in tickers.items():
            if symbol in df.columns:
                series = df[symbol].dropna()
                if not series.empty:
                    current = series.iloc[-1]
                    prev_week = series.iloc[-5] if len(series) > 5 else current
                    prev_month = series.iloc[-20] if len(series) > 20 else current
                    
                    # è®¡ç®—å˜åŒ–å¹…åº¦
                    chg_w = (current - prev_week) / prev_week * 100
                    chg_m = (current - prev_month) / prev_month * 100
                    
                    data_snapshot[name] = {
                        "price": current,
                        "chg_w": chg_w,
                        "chg_m": chg_m
                    }
    except Exception as e:
        print(f"Macro Data Error: {e}")
        
    return data_snapshot

def plot_pendulum(score):
    """
    ç”»éœåå¾·Â·é©¬å…‹æ–¯çš„é’Ÿæ‘† (Gauge Chart)
    score: 0 (æåº¦ææƒ§/è§æ¡) -> 50 (å¹³è¡¡) -> 100 (æåº¦è´ªå©ª/æ³¡æ²«)
    """
    fig = go.Figure(go.Indicator(
        mode = "gauge+number+delta",
        value = score,
        domain = {'x': [0, 1], 'y': [0, 1]},
        title = {'text': "å¸‚åœºé’Ÿæ‘†ä½ç½® (Market Pendulum)", 'font': {'size': 24}},
        delta = {'reference': 50, 'increasing': {'color': "red"}, 'decreasing': {'color': "green"}},
        gauge = {
            'axis': {'range': [None, 100], 'tickwidth': 1, 'tickcolor': "white"},
            'bar': {'color': "rgba(0,0,0,0)"}, # éšè—é»˜è®¤æŒ‡é’ˆï¼Œç”¨ steps é¢œè‰²
            'bgcolor': "white",
            'borderwidth': 2,
            'bordercolor': "gray",
            'steps': [
                {'range': [0, 20], 'color': '#00ff00', 'name': 'æåº¦æ‚²è§‚ (ä¹°å…¥)'},  # Green
                {'range': [20, 40], 'color': '#90ee90'},
                {'range': [40, 60], 'color': '#ffff00', 'name': 'å¹³è¡¡'},        # Yellow
                {'range': [60, 80], 'color': '#ffa500'},
                {'range': [80, 100], 'color': '#ff0000', 'name': 'æåº¦è´ªå©ª (å–å‡º)'} # Red
            ],
            'threshold': {
                'line': {'color': "black", 'width': 4},
                'thickness': 0.75,
                'value': score
            }
        }
    ))
    fig.update_layout(height=300, margin=dict(l=20, r=20, t=50, b=20))
    return fig

# --- åŠŸèƒ½ 7: AI æ™ºèƒ½åˆ†å‘å‘˜ (The Dispatcher) ---
def auto_dispatch(client, raw_text):
    """
    åˆ†æè¾“å…¥æ–‡æœ¬ï¼Œåˆ¤æ–­å±äºã€å®è§‚ã€‘è¿˜æ˜¯ã€å¾®è§‚æƒ…æŠ¥ã€‘ï¼Œå¹¶è‡ªåŠ¨å­˜å…¥å¯¹åº”çš„æ•°æ®åº“ã€‚
    """
    prompt = f"""
    ä»»åŠ¡ï¼šä½ æ˜¯ä¸€ä¸ªé‡‘èæƒ…æŠ¥åˆ†å‘å‘˜ã€‚è¯·åˆ†æä»¥ä¸‹æ–‡æœ¬ï¼Œå°†å…¶åˆ†ç±»ã€‚
    
    ã€æ–‡æœ¬å†…å®¹ã€‘ï¼š{raw_text}
    
    ã€åˆ†ç±»æ ‡å‡†ã€‘ï¼š
    1. **MACRO (å®è§‚)**: æ¶‰åŠå¤®è¡Œæ”¿ç­–(ç¾è”å‚¨)ã€é€šèƒ€æ•°æ®(CPI/PCE)ã€åœ°ç¼˜æ”¿æ²»ã€å¤§å®—å•†å“å‘¨æœŸã€å›½å€ºåˆ©ç‡ã€æ±‡ç‡ã€å…¨çƒç»æµå¢é•¿ã€‚
    2. **RADAR (å¾®è§‚/æƒ…æŠ¥)**: æ¶‰åŠå…·ä½“å…¬å¸(NVDA/Tesla)ã€å…·ä½“è¡Œä¸š(AI/SaaS)ã€ä¸ªè‚¡è´¢æŠ¥ã€äº§å“å‘å¸ƒã€å…·ä½“çš„å¹¶è´­æ¶ˆæ¯ã€‚
    
    è¯·è¾“å‡º JSON æ ¼å¼ï¼š
    {{
        "category": "MACRO" æˆ– "RADAR",
        "summary": "ä¸€å¥è¯æç‚¼æ ¸å¿ƒ (50å­—ä»¥å†…)",
        "tags": ["#æ ‡ç­¾1", "#æ ‡ç­¾2"],
        "bias": "åˆ©å¤š" æˆ– "åˆ©ç©º" æˆ– "ä¸­æ€§"
    }}
    """
    
    try:
        # 1. AI åˆ¤åˆ«
        res = client.chat.completions.create(
            model="deepseek-chat",
            messages=[{"role": "user", "content": prompt}],
            response_format={"type": "json_object"}
        )
        result = json.loads(res.choices[0].message.content)
        
        # 2. è‡ªåŠ¨å­˜å…¥æ•°æ®åº“ (Session State)
        # æ³¨æ„ï¼šè¿™é‡Œéœ€è¦ st.session_state å·²ç»åˆå§‹åŒ–ã€‚å®é™…è°ƒç”¨æ—¶åœ¨é¡µé¢é‡Œæ“ä½œæ›´å®‰å…¨ã€‚
        return result
    
    except Exception as e:
        return {"error": str(e)}
    
# utils.py

import streamlit as st

def check_password():
    """å¦‚æœä¸è¾“å…¥æ­£ç¡®å¯†ç ï¼Œå°±åœæ­¢æ¸²æŸ“åç»­å†…å®¹"""
    if "password_correct" not in st.session_state:
        st.session_state["password_correct"] = False

    if not st.session_state["password_correct"]:
        st.text_input("è¯·è¾“å…¥æŒ‡æŒ¥å®˜å£ä»¤:", type="password", key="password_input", on_change=password_entered)
        return False
    return True

def password_entered():
    # åœ¨ secrets é‡Œè®¾ç½®ä¸€ä¸ª PASSWORD = "ä½ çš„å¯†ç "
    if st.session_state["password_input"] == st.secrets["PASSWORD"]:
        st.session_state["password_correct"] = True
    else:
        st.error("å£ä»¤é”™è¯¯ï¼Œæ‹’ç»è®¿é—®ã€‚")