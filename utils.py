import json
import os
import streamlit as st
from datetime import datetime

# --- é…ç½®åŒº ---
# 1. æ•°æ®å­˜å‚¨æ–‡ä»¶
DB_FILE = "news_database.json"

# 2. Obsidian ä»“åº“è·¯å¾„ (éœ€è¦ä¿®æ”¹ä¸ºä½ ç”µè„‘ä¸Šçš„çœŸå®è·¯å¾„!)
# ä¾‹å¦‚: "/Users/zhanghao/yangyun/Code_projects/obsidian_notes/å…»äº‘åä½œ/å†³ç­–å½’æ¡£"
OBSIDIAN_PATH = "/Users/zhanghao/yangyun/Code_projects/obsidian_notes" 

# --- åŠŸèƒ½ 1: åŠ è½½/ä¿å­˜é›·è¾¾æ•°æ® ---
def load_data():
    """ä»æœ¬åœ° JSON æ–‡ä»¶åŠ è½½æ•°æ®ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è¿”å›é»˜è®¤ç©ºåˆ—è¡¨"""
    if os.path.exists(DB_FILE):
        with open(DB_FILE, "r", encoding="utf-8") as f:
            return json.load(f)
    return [] # è¿”å›ç©ºåˆ—è¡¨ï¼Œç­‰å¾…åˆå§‹åŒ–

def save_data(news_list):
    """æŠŠé›·è¾¾æ•°æ®ä¿å­˜åˆ°æœ¬åœ° JSON"""
    with open(DB_FILE, "w", encoding="utf-8") as f:
        json.dump(news_list, f, ensure_ascii=False, indent=4)

# --- åŠŸèƒ½ 2: å¯¼å‡ºå†³ç­–åˆ° Obsidian ---
def save_to_obsidian(case_data, decision_note):
    """
    ç”Ÿæˆ Markdown æ–‡ä»¶å¹¶å†™å…¥ Obsidian æ–‡ä»¶å¤¹
    """
    # 1. ç”Ÿæˆæ–‡ä»¶å (ä¾‹å¦‚: 2026-02-06_NVDA_å†³ç­–å¤‡å¿˜.md)
    date_str = datetime.now().strftime("%Y-%m-%d")
    clean_title = case_data['title'].replace("/", "_").replace(" ", "_")
    filename = f"{date_str}_{clean_title}.md"
    full_path = os.path.join(OBSIDIAN_PATH, filename)
    
    # 2. ç”Ÿæˆ Markdown å†…å®¹ (Beancount é£æ ¼æ ‡ç­¾)
    content = f"""---
id: {case_data['id']}
date: {date_str}
tags: {case_data['tags']}
surprise: {case_data['surprise']}
status: Closed
---

# âš–ï¸ å†³ç­–å¤‡å¿˜å½•: {case_data['title']}

## 1. æ ¸å¿ƒæƒ…æŠ¥
> {case_data['summary']}

## 2. ä¾¦æ¢æŠ¥å‘Š (Evidence)
{case_data.get('investigation', 'æ— è¯¦ç»†æŠ¥å‘Š')}

## 3. æœ€ç»ˆè£å†³ (Verdict)
**ğŸ‘¨â€âš–ï¸ æ³•å®˜ç¬”è®°:**
{decision_note}

---
*Generated by YangYun AI System*
"""

    # 3. å†™å…¥æ–‡ä»¶
    try:
        # ç¡®ä¿ç›®å½•å­˜åœ¨
        os.makedirs(os.path.dirname(full_path), exist_ok=True)
        with open(full_path, "w", encoding="utf-8") as f:
            f.write(content)
        return True, full_path
    except Exception as e:
        return False, str(e)